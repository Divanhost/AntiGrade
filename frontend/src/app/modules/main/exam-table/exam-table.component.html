<div class="e-container mt-3"></div>
<div class="page-container table-editable m-auto no-overflow">
  <div class="d-flex justify-content-between w-100">
    <h2> <a [routerLink]="[ '/subjects/rating', subjectId ]" class="mr-1">Рейтинговая таблица</a> |
      <a class="active mx-1" [routerLink]="[ '/subjects/exam', subjectId ]">Экзамен</a> |
      <a [routerLink]="[ '/subjects/rating/additional', subjectId ]" class="ml-1">Добор</a>
      <img src="assets/undo.svg" style="width: 25px; height: 25px; cursor:pointer;" [routerLink]="['/subjects']" class="ml-3 mb-1">
    </h2>
    <div class="btn btn-success mb-3" (click)="updateExamResults()"> Сохранить</div>
  </div>

  <div class="text-center" *ngIf="!loaded">
    <div class="spinner-border" style="width: 10rem; height: 10rem; color: #007bff;" role="status">
      <span class="sr-only">Loading...</span>
    </div>
  </div>
  <ng-container *ngIf="loaded">
    <table class="table table-bordered table-responsive-md text-center">
      <thead>
        <tr>
          <th>
            Мероприятие
          </th>
          <th rowspan="2">
            Итог за семестр
          </th>
          <th rowspan="2">
            Добор
          </th>
          <th colspan="3">
            Основная сдача
          </th>
          <th colspan="2">
            Первая пересдача
          </th>
          <th colspan="2">
            Вторая пересдача
          </th>
          <th rowspan="2">
            Бонус
          </th>
          <th rowspan="2">
            Итог
          </th>
        </tr>
        <tr>
          <th>
            Студент
          </th>
          <th>
            40
          </th>
          <th>
            Автомат
          </th>
          <th>
            Неявка
          </th>
          <th>
            40
          </th>
          <th>
            Неявка
          </th>
          <th>
            40
          </th>
          <th>
            Неявка
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of data" [ngClass]="{'disabled': !canEdit(row.totals)}">
          <td>
            {{row.currentStudent.lastName}} {{row.currentStudent.firstName}}
          </td>
          <td>
            {{row.totals}}
          </td>
          <td>
            {{row.additional}}
          </td>
          <!-- First pass -->
          <ng-container *ngIf="canEdit(row.totals); else elseTemplate">
            <td (keydown.enter)="$event.target.blur();" [ngClass]="{'disabled': isAdditionalMode}"
              (blur)="updateWorkPoints(row.examResult, 'first', $event)" contenteditable="true">
              {{row.examResult.points}}
            </td>
          </ng-container>
          <ng-template #elseTemplate>
            <td>
              {{row.examResult.points}}
            </td>
          </ng-template>
          <td class="check" [ngClass]="{'disabled': canEdit(row.totals) && isAdditionalMode}">
            <mat-checkbox class="example-margin" (change)="addFull(row.examResult)" color="primary"
              [disabled]="row.examResult.points !== 0">
              <label></label>
            </mat-checkbox>
          </td>
          <td class="check" [ngClass]="{'disabled': canEdit(row.totals) && isAdditionalMode}">
            <mat-checkbox class="example-margin" (change)="addZero(row.examResult)" color="warn"
              [disabled]="row.examResult.points !== 0" [checked]="row.examResult.points === 0 && isAdditionalMode">
              <label></label>
            </mat-checkbox>
          </td>
          <!-- end First pass -->
          <!-- Second pass -->
          <ng-container *ngIf="canEdit(row.totals); else elseTemplate">
            <td (keydown.enter)="$event.target.blur();" [ngClass]="{'disabled': !isAdditionalMode}"
              (blur)="updateWorkPoints(row.examResult,'second', $event)" contenteditable="true">
              {{row.examResult.secondPassPoints}}
            </td>
          </ng-container>
          <ng-template #elseTemplate>
            <td>
              {{row.examResult.secondPassPoints}}
            </td>
          </ng-template>
          <td class="check" [ngClass]="{'disabled': canEdit(row.totals) && !isAdditionalMode}">
            <mat-checkbox class="example-margin" (change)="addZeroSecond(row.examResult)" color="warn"
              [disabled]="row.examResult.secondPassPoints !== 0">
              <label></label>
            </mat-checkbox>
          </td>
          <!-- end Second pass -->
          <!-- Third pass -->
          <ng-container *ngIf="canEdit(row.totals); else elseTemplate">
            <td (keydown.enter)="$event.target.blur();" [ngClass]="{'disabled': !isAdditionalMode}"
              (blur)="updateWorkPoints(row.examResult, 'third', $event)" contenteditable="true">
              {{row.examResult.thirdPassPoints}}
            </td>
          </ng-container>
          <ng-template #elseTemplate>
            <td>
              {{row.examResult.thirdPassPoints}}
            </td>
          </ng-template>
          <td class="check" [ngClass]="{'disabled': canEdit(row.totals) && !isAdditionalMode}">
            <mat-checkbox class="example-margin" (change)="addZeroThird(row.examResult)" color="warn"
              [disabled]="row.examResult.thirdPassPoints !== 0">
              <label></label>
            </mat-checkbox>
          </td>
          <!-- end Third pass -->
          <td>
          </td>
          <td>
            {{row.sumOfPoints}}
          </td>
        </tr>
      </tbody>
    </table>
  </ng-container>
</div>